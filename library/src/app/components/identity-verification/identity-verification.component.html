<ng-container *ngIf="(isRecoverable$ | async) !== false">
  <ng-container *ngIf="configService.getConfig$() | async as config">
    <mat-card-title>
      <app-cybrid-logo
        fill="{{ config.theme === 'LIGHT' ? '#3f51b5' : 'white' }}"
      ></app-cybrid-logo>
    </mat-card-title>
    <mat-card-content>
      <ng-container *ngIf="error$ | async; else content">
        <div class="verification-content">
          <div>
            <mat-icon color="warn">cancel</mat-icon>
            <strong>{{
              'identityVerification.unexpectedError' | translate
            }}</strong>
          </div>
        </div>
      </ng-container>
      <ng-template #content>
        <ng-container *ngIf="isLoading$ | async">
          <div class="verification-content">
            <div>
              <app-loading [diameter]="16"></app-loading>
              <strong>{{
                stepper.selectedIndex === 0
                  ? ('identityVerification.checkStatus' | translate)
                  : ('identityVerification.verifying' | translate)
              }}</strong>
            </div>
          </div>
        </ng-container>
        <mat-stepper #stepper linear="true" animationDuration="0">
          <mat-step>
            <ng-container *ngIf="(customer$ | async)?.state as state">
              <ng-container [ngSwitch]="state">
                <ng-container *ngSwitchCase="'verified'">
                  <div class="verification-content">
                    <div>
                      <mat-icon color="primary">check_circle</mat-icon>
                      <strong>{{
                        'identityVerification.verified' | translate
                      }}</strong>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngSwitchCase="'rejected'">
                  <div class="verification-content">
                    <div>
                      <mat-icon color="warn">cancel</mat-icon>
                      <strong>{{
                        'identityVerification.rejected' | translate
                      }}</strong>
                    </div>
                    <p>{{ 'identityVerification.support' | translate }}</p>
                  </div>
                </ng-container>
                <ng-container *ngSwitchCase="'unverified'">
                  <div class="verification-content">
                    <div>
                      <mat-icon color="primary">arrow_circle_right</mat-icon>
                      <strong>{{
                        'identityVerification.unverified' | translate
                      }}</strong>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
              <div class="verification-actions">
                <button
                  id="cancel"
                  mat-stroked-button
                  [disabled]="state === 'verified' || state === 'rejected'"
                >
                  {{ 'cancel' | translate }}
                </button>
                <button
                  *ngIf="state === 'unverified'; else done"
                  id="verify"
                  mat-flat-button
                  color="primary"
                  matStepperNext
                  (click)="verifyIdentity()"
                >
                  {{ 'begin' | translate }}
                </button>
                <ng-template #done>
                  <button
                    id="customer-button-done"
                    mat-flat-button
                    color="primary"
                    (click)="onComplete()"
                  >
                    {{ 'done' | translate }}
                  </button>
                </ng-template>
              </div>
            </ng-container>
          </mat-step>
          <mat-step>
            <ng-container *ngIf="identity$ | async as identity">
              <ng-container [ngSwitch]="identity.outcome">
                <ng-container *ngSwitchCase="'passed'">
                  <div class="verification-content">
                    <div>
                      <mat-icon color="primary">check_circle</mat-icon>
                      <strong>{{
                        'identityVerification.verified' | translate
                      }}</strong>
                    </div>
                  </div>
                </ng-container>
                <ng-container *ngSwitchCase="'failed'">
                  <div class="verification-content">
                    <div>
                      <mat-icon color="warn">cancel</mat-icon>
                      <strong>{{
                        'identityVerification.rejected' | translate
                      }}</strong>
                    </div>
                    <p *ngFor="let reason of identity.failure_codes">
                      {{ reason }}
                    </p>
                  </div>
                </ng-container>
                <ng-container *ngSwitchDefault>
                  <ng-container *ngIf="identity.persona_state === 'reviewing'">
                    <div class="verification-content">
                      <div>
                        <mat-icon color="primary">help</mat-icon>
                        <strong>{{
                          'identityVerification.reviewing' | translate
                        }}</strong>
                      </div>
                      <p>{{ 'identityVerification.support' | translate }}</p>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-container>
              <div class="verification-actions">
                <button
                  id="identity-button-done"
                  mat-flat-button
                  color="primary"
                  disabled="{{ isLoading$ | async }}"
                  (click)="onComplete()"
                >
                  {{ 'done' | translate }}
                </button>
              </div>
            </ng-container>
          </mat-step>
          <mat-step>
            <div class="verification-content">
              <div>
                <mat-icon color="primary">play_circle</mat-icon>
                <strong>{{ 'identityVerification.resume' | translate }}</strong>
              </div>
            </div>
            <div class="verification-actions">
              <button mat-stroked-button>{{ 'cancel' | translate }}</button>
              <button
                mat-flat-button
                color="primary"
                matStepperNext
                (click)="verifyIdentity(); stepper.previous()"
              >
                {{ 'resume' | translate }}
              </button>
            </div>
          </mat-step>
        </mat-stepper>
      </ng-template>
    </mat-card-content>
  </ng-container>
</ng-container>
